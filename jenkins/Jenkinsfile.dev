pipeline {
  
  agent none

  options {
    disableConcurrentBuilds()

    buildDiscarder(
      logRotator(
        numToKeepStr: '10'
      )
    )

    office365ConnectorWebhooks([[
      url: "${env.TEAMS_WEBHOOK_URL}",
      notifyUnstable: true,
      notifyFailure: true,
      notifyBackToNormal: true,
      startNotification: false,
      notifySuccess: false,
      notifyAborted: false,
      notifyNotBuilt: false,
      notifyRepeatedFailure: false
    ]])
  }
  environment {
    GRAPHQL_TOKEN = credentials('dev-load-testing-proposal-api-key')
    BROWSER_BASE_URL = 'https://devproposal.facilities.rl.ac.uk'
    GRAPHQL_URL = 'https://devproposal.facilities.rl.ac.uk/graphql'
    HOME = '.'
    USER_SETUP_DOTENV_PATH = './.env'
  }

  stages {

        stage('Build load testing') {
          agent {
            docker {
              label 'linux && docker'
              image 'node:21.7-alpine'
              alwaysPull true
            }
          }
          steps {
            copyArtifacts(
              projectName: 'Dev_Build_BisAppSettings',
              filter: 'BISAppSettings/proposal-load-tester/k6/dev/.env',
              selector: lastSuccessful(),
              fingerprintArtifacts: true
            )
              sh 'ls'
              sh 'rm -rf ./BISAppSettings/Node'
              sh 'rm -rf ./.env'
              sh 'rm -rf ./node_modules'
              sh 'rm -rf ./apps/k6-tests/node_modules'
              sh 'rm -rf ./apps/user-setup/node_modules'
              sh 'ls'
              // clear npm cache
              sh 'npm cache clean --force'
              sh 'ls'
              //run npm install
              sh 'npm install'
              sh 'ls'
              sh 'npm run build'
              
              sh 'ls'

              sh 'ls ./'

              sh 'npm run start:user-setup'

            
          }
    }
    // stage('Run load testing on dev') {

    //   steps {
    //     copyArtifacts(
    //       projectName: 'Dev_Build_BisAppSettings',
    //       filter: 'BISAppSettings/proposal-load-tester/k6/dev/.env',
    //       selector: lastSuccessful(),
    //       fingerprintArtifacts: true,
    //       flatten: true
    //     )
    //     sh (
    //       '''
    //         node ./apps/user-setup/build/index.js

    //         # To pass VUS and Iterations uncomment and pass these envs
    //         # export SC1_BROWSER_VUS=60
    //         # export SC1_GRAPHQL_VUS=80
    //         # export SC1_GRAPHQL_ITERATIONS=5

    //         # k6 run --no-usage-report - < <(cat ./apps/k6-tests/test/sc1-load-test.js)
    //       '''
    //     )
    //   }
    // }
  }

  // post {
  //   regression {
  //       emailext(
  //         subject: '$DEFAULT_SUBJECT',
  //         body: '$DEFAULT_CONTENT',
  //         to: '$DEFAULT_RECIPIENTS',
  //         recipientProviders: [developers()]
  //       )
  //     }

  //   fixed {
  //     emailext(
  //     subject: '$DEFAULT_SUBJECT',
  //     body: '$DEFAULT_CONTENT',
  //     to: '$DEFAULT_RECIPIENTS',
  //     recipientProviders: [developers()]
  //   )
  //   }
  // }
}
